name: Daily Restaurant Validation

on:
  schedule:
    # UTC 15:00 = KST 00:00 (자정)
    - cron: '0 15 * * *'
  workflow_dispatch:
    # 수동 실행 가능 (테스트용)

jobs:
  validate-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Release 생성 및 Wiki 접근에 필요

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install
        working-directory: ./scripts

      - name: Validate restaurants
        env:
          KAKAO_API_KEY: ${{ secrets.KAKAO_API_KEY }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: node validate-restaurants.js
        working-directory: ./scripts

      - name: Generate Wiki report
        run: node generate-wiki-report.js
        working-directory: ./scripts

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./scripts/output/restaurants_latest.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: data-${{ steps.version.outputs.version }}
          name: Restaurant Data ${{ steps.version.outputs.version }}
          body: |
            자동 생성된 식당 데이터입니다.

            - 버전: ${{ steps.version.outputs.version }}
            - 생성 시간: ${{ github.event.repository.updated_at }}

            ## 첨부 파일
            - `restaurants_latest.json` - 앱용 식당 데이터
            - `validation_report.json` - 검증 결과 (JSON)
            - `Validation-Report.md` - 검증 리포트 (마크다운)
          files: |
            scripts/output/restaurants_latest.json
            scripts/output/validation_report.json
            scripts/output/Validation-Report.md
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload validation report as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: validation-report
          path: ./scripts/output/
          retention-days: 7
